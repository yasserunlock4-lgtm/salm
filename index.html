import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, updateDoc, increment, onSnapshot } from 'firebase/firestore';

// ุฅุนุฏุงุฏุงุช ุงููุงูุฑุจูุณ - ูุชู ุชุนุจุฆุชูุง ุชููุงุฆูุงู ูู ุงูุจูุฆุฉ
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'salem-daaboul-pro';

// ุฅุนุฏุงุฏุงุช ุงูุฌูุงุฆุฒ ูุงูููุช
const PRIZES = [
  { name: "0.01$", type: "money", value: 0.01, icon: "๐ช" },
  { name: "0.05$", type: "money", value: 0.05, icon: "๐ต" },
  { name: "0.10$", type: "money", value: 0.10, icon: "๐ฐ" },
  { name: "0.25$", type: "money", value: 0.25, icon: "๐" },
  { name: "ุญุธ ุฃููุฑ", type: "none", value: 0, icon: "๐" },
  { name: "ุญุธ ุฃููุฑ", type: "none", value: 0, icon: "๐" }
];

const STORE_ITEMS = [
  { id: 'asia_500', name: 'ุฑุตูุฏ ุขุณูุง ุณูู (ูุงุด)', price: 500.00, icon: '๐ฒ' },
  { id: 'zain_500', name: 'ุฑุตูุฏ ุฒูู ุงูุนุฑุงู', price: 500.00, icon: '๐ฑ' },
  { id: 'atheer_500', name: 'ุฑุตูุฏ ุฃุซูุฑ', price: 500.00, icon: '๐ถ' },
  { id: 'cash_home', name: 'ุณุญุจ ูุงุด ููุนููุงู', price: 500.00, icon: '๐' },
];

const COOLDOWN = 10 * 60 * 1000; // 10 ุฏูุงุฆู
const MIN_WITHDRAW = 500.00; // ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ

export default function App() {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState({ balance: 0, lastOpenTime: 0, completedTasks: [] });
  const [activeSection, setActiveSection] = useState('home');
  const [isOpening, setIsOpening] = useState(false);
  const [modal, setModal] = useState({ visible: false, prize: null });
  const [timeLeft, setTimeLeft] = useState(0);

  // 1. ูุธุงู ุชุณุฌูู ุงูุฏุฎูู ุงูุชููุงุฆู
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("ุฎุทุฃ ูู ุงููุตุงุฏูุฉ", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน Firestore
  useEffect(() => {
    if (!user) return;
    const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
    const unsubscribe = onSnapshot(userRef, (docSnap) => {
      if (docSnap.exists()) {
        setUserData(docSnap.data());
      } else {
        setDoc(userRef, { balance: 0, lastOpenTime: 0, completedTasks: [], uid: user.uid });
      }
    }, (err) => console.error("ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช", err));
    return () => unsubscribe();
  }, [user]);

  // 3. ุชุญุฏูุซ ูุคูุช ุงูุงูุชุธุงุฑ
  useEffect(() => {
    const interval = setInterval(() => {
      if (userData.lastOpenTime) {
        const now = Date.now();
        const diff = now - userData.lastOpenTime;
        const remaining = Math.max(0, COOLDOWN - diff);
        setTimeLeft(remaining);
      } else {
        setTimeLeft(0);
      }
    }, 1000);
    return () => clearInterval(interval);
  }, [userData.lastOpenTime]);

  // ูุชุญ ุงูููุณ
  const handleOpenPacket = async () => {
    if (isOpening || timeLeft > 0 || !user) return;
    setIsOpening(true);
    
    setTimeout(async () => {
      const prize = PRIZES[Math.floor(Math.random() * PRIZES.length)];
      const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
      
      try {
        await updateDoc(userRef, {
          balance: increment(prize.type === 'money' ? prize.value : 0),
          lastOpenTime: Date.now()
        });
        setModal({ visible: true, prize });
      } catch (err) {
        console.error("ุฎุทุฃ ูู ุงูุชุญุฏูุซ", err);
      } finally {
        setIsOpening(false);
      }
    }, 600);
  };

  // ุฅููุงู ุงููููุฉ
  const completeTask = async (taskId, bonus, url) => {
    if (!user || userData.completedTasks?.includes(taskId)) return;
    window.open(url, '_blank');
    
    setTimeout(async () => {
      try {
        const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
        await updateDoc(userRef, {
          balance: increment(bonus),
          completedTasks: [...(userData.completedTasks || []), taskId]
        });
      } catch (err) {
        console.error("ุฎุทุฃ ูู ุงููููุฉ", err);
      }
    }, 3000);
  };

  // ุทูุจ ุงูุณุญุจ
  const buyItem = async (item) => {
    if (userData.balance < MIN_WITHDRAW) {
      alert(`ุงูุฑุตูุฏ ุบูุฑ ูุงูู! ุชุญุชุงุฌ ูููุตูู ุฅูู ${MIN_WITHDRAW}$ ููุณุญุจ. ุฑุตูุฏู ุงูุญุงูู: ${userData.balance.toFixed(2)}$`);
      return;
    }

    const confirmPurchase = window.confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุณุญุจ ูุจูุบ ${item.price}$ุ`);
    if (!confirmPurchase) return;

    try {
      const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
      await updateDoc(userRef, { balance: increment(-item.price) });
      alert(`ุชู ุฅุฑุณุงู ุทูุจ ุงูุณุญุจ ุจูุฌุงุญ! ุณูุชู ุงูุชูุงุตู ูุนู ูุฑูุจุงู.`);
      window.open(`https://t.me/your_user?text=ุทูุจ ุณุญุจ ุฌุฏูุฏ ูู ุงููุณุชุฎุฏู: ${user.uid}`, '_blank');
    } catch (err) {
      console.error("ุฎุทุฃ ูู ุงูุณุญุจ", err);
    }
  };

  const formatTime = (ms) => {
    const mins = Math.floor(ms / 60000);
    const secs = Math.floor((ms % 60000) / 1000);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans flex flex-col items-center p-4 pb-28 select-none rtl" dir="rtl">
      
      {/* ูุงุฌูุฉ ุงููุนูููุงุช ุงูุนูููุฉ */}
      <div className="w-full max-w-md flex justify-between items-center mb-10 mt-2">
        <div className="bg-slate-900 rounded-3xl px-6 py-3 border border-green-500/20 shadow-xl flex flex-col items-center">
          <span className="text-[10px] text-slate-400 font-bold uppercase">ุงูุฑุตูุฏ</span>
          <span className="text-xl font-black text-green-500">{(userData.balance || 0).toFixed(2)}$</span>
        </div>
        <div className="bg-slate-900 rounded-3xl px-6 py-3 border border-blue-500/20 shadow-xl flex flex-col items-center">
          <span className="text-[10px] text-slate-400 font-bold uppercase">ุงููุคูุช</span>
          <span className={`text-xl font-black ${timeLeft > 0 ? 'text-blue-400' : 'text-green-400'}`}>
            {timeLeft > 0 ? formatTime(timeLeft) : 'ูุชุงุญ'}
          </span>
        </div>
      </div>

      {/* ุงููุณู ุงูุฑุฆูุณู */}
      {activeSection === 'home' && (
        <div className="w-full max-w-md flex flex-col items-center animate-in fade-in zoom-in duration-500">
          <img src="https://i.ibb.co/3yxmRCHd/1000124039.jpg" className="w-28 h-28 rounded-full border-4 border-amber-500 shadow-2xl mb-4" alt="ุณุงูู ุฏุนุจูู" />
          <h1 className="text-2xl font-black text-amber-500 mb-2">ูุณุงุจูุงุช ุณุงูู ุฏุนุจูู</h1>
          <p className="text-xs text-slate-400 mb-12">ุงุฌูุน ุงูุณูุชุงุช ูู 10 ุฏูุงุฆู</p>

          <div onClick={handleOpenPacket} className={`relative cursor-pointer transition-all duration-300 ${isOpening ? 'scale-75' : 'hover:scale-105 active:scale-90'} ${timeLeft > 0 ? 'opacity-40 grayscale' : 'animate-bounce'}`}>
             <div className="w-44 h-56 bg-gradient-to-b from-amber-800 to-amber-950 border-4 border-amber-500 rounded-[2.5rem] flex flex-col items-center justify-center shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
                <div className="w-full h-10 bg-amber-700/30 absolute top-0 rounded-t-[2.1rem]"></div>
                <span className="text-4xl font-black text-amber-500 drop-shadow-lg">ุฌุจุณ</span>
                <span className="text-xs font-bold text-amber-200/50 mt-1">ุณุงูู</span>
             </div>
          </div>
          
          <button 
            onClick={handleOpenPacket} 
            disabled={timeLeft > 0 || isOpening} 
            className={`mt-12 w-full max-w-xs py-5 rounded-[2rem] font-black text-xl shadow-2xl transition-all ${timeLeft > 0 ? 'bg-slate-800 text-slate-500' : 'bg-gradient-to-r from-amber-500 to-yellow-600 text-black active:scale-95'}`}
          >
            {isOpening ? 'ุฌุงุฑู ุงููุชุญ...' : timeLeft > 0 ? `ุงูุชุธุฑ ${formatTime(timeLeft)}` : 'ุงูุชุญ ุงูููุณ ุงูุขู'}
          </button>
        </div>
      )}

      {/* ูุณู ุงูููุงู */}
      {activeSection === 'tasks' && (
        <div className="w-full max-w-md space-y-4 animate-in slide-in-from-bottom-5">
          <h2 className="text-2xl font-black mb-6 text-center">ุงูููุงู ุงูููููุฉ</h2>
          {[
            { id: 'tg_task', name: 'ููุงุฉ ุงูุชููุฌุฑุงู ุงูุฑุณููุฉ', bonus: 0.50, icon: '๐ข', url: 'https://t.me/your_channel' },
            { id: 'ig_task', name: 'ูุชุงุจุนุฉ ุญุณุงุจ ุงูุฅูุณุชูุฑุงู', bonus: 0.25, icon: '๐ธ', url: 'https://instagram.com/your_account' },
            { id: 'yt_task', name: 'ุงุดุชุฑุงู ููุงุฉ ุงูููุชููุจ', bonus: 0.75, icon: '๐ฅ', url: 'https://youtube.com/your_channel' }
          ].map(task => {
            const isDone = userData.completedTasks?.includes(task.id);
            return (
              <div key={task.id} className="bg-slate-900/50 p-5 rounded-[2rem] border border-white/5 flex justify-between items-center shadow-lg">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-slate-800 rounded-2xl flex items-center justify-center text-2xl">{task.icon}</div>
                  <div>
                    <p className="font-bold text-sm">{task.name}</p>
                    <p className="text-xs text-green-500 font-black">+{task.bonus}$ ููุงูุฃุฉ</p>
                  </div>
                </div>
                <button 
                  onClick={() => completeTask(task.id, task.bonus, task.url)} 
                  disabled={isDone} 
                  className={`px-6 py-2 rounded-xl text-[10px] font-black transition-all ${isDone ? 'bg-green-500/10 text-green-500' : 'bg-white text-black active:scale-90'}`}
                >
                  {isDone ? 'ููุชูู โ' : 'ุชูููุฐ'}
                </button>
              </div>
            );
          })}
        </div>
      )}

      {/* ูุณู ุงููุชุฌุฑ / ุงูุณุญุจ */}
      {activeSection === 'store' && (
        <div className="w-full max-w-md space-y-4 animate-in slide-in-from-bottom-5">
          <div className="text-center mb-8">
            <h2 className="text-2xl font-black">ูุฑูุฒ ุงูุณุญุจ</h2>
            <p className="text-xs text-slate-400 mt-1">ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ ูู <span className="text-amber-500 font-black">500.00$</span></p>
          </div>
          {STORE_ITEMS.map(item => (
            <div key={item.id} className="bg-slate-900/50 p-5 rounded-[2.5rem] border border-white/5 flex justify-between items-center">
              <div className="flex items-center gap-4">
                <span className="text-4xl">{item.icon}</span>
                <span className="font-bold text-sm">{item.name}</span>
              </div>
              <button 
                onClick={() => buyItem(item)} 
                className="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-2xl text-[10px] font-black shadow-lg transition-all active:scale-95"
              >
                {item.price}$
              </button>
            </div>
          ))}
        </div>
      )}

      {/* ุดุฑูุท ุงูุชููู ุงูุณููู */}
      <nav className="fixed bottom-8 left-6 right-6 bg-slate-900/90 backdrop-blur-xl border border-white/10 rounded-[3rem] p-3 flex justify-around shadow-2xl z-50">
        <button onClick={() => setActiveSection('home')} className={`flex flex-col items-center gap-1 px-8 py-2 rounded-[2rem] transition-all ${activeSection === 'home' ? 'text-amber-500 bg-amber-500/10' : 'text-slate-500'}`}>
          <span className="text-2xl">๐</span>
          <span className="text-[10px] font-black">ุงูุฑุฆูุณูุฉ</span>
        </button>
        <button onClick={() => setActiveSection('tasks')} className={`flex flex-col items-center gap-1 px-8 py-2 rounded-[2rem] transition-all ${activeSection === 'tasks' ? 'text-blue-500 bg-blue-500/10' : 'text-slate-500'}`}>
          <span className="text-2xl">๐</span>
          <span className="text-[10px] font-black">ุงูููุงู</span>
        </button>
        <button onClick={() => setActiveSection('store')} className={`flex flex-col items-center gap-1 px-8 py-2 rounded-[2rem] transition-all ${activeSection === 'store' ? 'text-green-500 bg-green-500/10' : 'text-slate-500'}`}>
          <span className="text-2xl">๐ต</span>
          <span className="text-[10px] font-black">ุงูุณุญุจ</span>
        </button>
      </nav>

      {/* ูุงูุฐุฉ ุงูุฌุงุฆุฒุฉ */}
      {modal.visible && (
        <div className="fixed inset-0 bg-black/95 flex items-center justify-center p-6 z-[100] backdrop-blur-md animate-in fade-in">
          <div className="bg-slate-900 border-2 border-amber-500/50 p-12 rounded-[4rem] text-center max-w-xs w-full shadow-[0_0_100px_rgba(245,158,11,0.2)] animate-in zoom-in-75">
            <div className="text-8xl mb-6 animate-bounce">{modal.prize?.icon}</div>
            <h2 className="text-3xl font-black text-white mb-2">{modal.prize?.name === 'ุญุธ ุฃููุฑ' ? 'ูุง ููุงุณู!' : 'ูุจุฑูู!'}</h2>
            <p className="text-5xl font-black text-amber-500 mb-8 tracking-tighter">{modal.prize?.name}</p>
            <button 
              onClick={() => setModal({ visible: false, prize: null })} 
              className="w-full bg-gradient-to-r from-amber-500 to-yellow-600 text-black py-5 rounded-[2rem] font-black text-lg shadow-xl active:scale-95"
            >
              ุงุณุชูุฑุงุฑ ุงูุฌูุน
            </button>
          </div>
        </div>
      )}

      <div className="mt-auto opacity-10 text-[8px] font-mono">APP_ID: {appId}</div>
    </div>
  );
}
